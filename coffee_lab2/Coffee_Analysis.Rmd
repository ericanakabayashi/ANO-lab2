---
title: "Estimating Coffee Ratings - Dataset from Coffee Quality Institute"
author: "Abraham Yang, Erica Nakabayashi, Melissa Oliveira"
date: '2023-04-20'
output: pdf_document
header-includes:
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and set options, include=FALSE}

library(tidyverse)
library(magrittr)
library(stargazer)
library(sandwich)
library(lmtest)
library(patchwork)
library(car)
library(gridExtra)
library(caret)

theme_set(theme_bw())

```

```{r load DBs and filtering, message = FALSE, include=FALSE}
#Upload main dataset
merged_data_cleaned <- read.csv("merged_data_cleaned.csv")
coffee_df<-merged_data_cleaned

#Fixing country names for equivalency 
colnames(coffee_df)[4] <- "country"
coffee_df$country[coffee_df$country == "Tanzania, United Republic Of"] <- "Tanzania"
coffee_df$country[coffee_df$country == "United States (Hawaii)"] <- "United States"
coffee_df$country[coffee_df$country == "United States (Puerto Rico)"] <- "United States"
coffee_df$country[coffee_df$country == "Cote d?Ivoire"] <- "Ivory Coast"

#Import Tropical Dataset - https://worldpopulationreview.com/country-rankings/tropical-countries
tropicalcountries <- read.csv("data_tropical.csv")
tropicalcountries<- tropicalcountries %>% 
  mutate(Tropical = if_else(fullyTropical =="true" ,
                                   "FullyTropical",
                                   "PartiallyTropical"))
#add Japan - not tropical
tropicalcountries[nrow(tropicalcountries)+1,] = tropicalcountries[nrow(tropicalcountries),]
tropicalcountries[nrow(tropicalcountries),5] = "Japan"
tropicalcountries[nrow(tropicalcountries),17] = "NotTropical"
tropicalcountries[nrow(tropicalcountries),9] = "Asia"
tropicalcountries[nrow(tropicalcountries),10] = "Eastern Asia"

#First merge
coffee_tropical_merged = merge(x = coffee_df, y = tropicalcountries, by = "country")


#Import Average Altitude Dataset - From Wikipedia
avg_alt <- read.csv("averagealtitude.csv")
colnames(avg_alt)[1] <- "country"
avg_alt[nrow(avg_alt)+1,] = avg_alt[nrow(avg_alt),]
avg_alt[nrow(avg_alt),1] = "Ivory Coast"
avg_alt[nrow(avg_alt),2] = 250


#Second merge
coffee_tropical_avgalt_merged = merge(x = coffee_tropical_merged, y = avg_alt, by = "country")

```


```{r histograms_, out.width="70%", align = 'center', fig.cap="distribution", echo=FALSE, include=TRUE}
par(mfrow = c(2, 1))

hist(coffee_tropical_avgalt_merged$Total.Cup.Points, which=3,ylab=NULL,main=NULL)
hist(coffee_tropical_avgalt_merged$altitude_low_meters, which=3,ylab=NULL,main=NULL)

```

###Cleaning the data
A few observations were above Everest altitude, and were excluded.
We also gathered data from average altitude around the world and whatever fell behind 20% of average countries altitude were also excluded.

```{r glimpse excluding variables that look weird on dataset, include=FALSE}
df <- subset(coffee_tropical_avgalt_merged,Total.Cup.Points > 0) #clean invalid score
df <- subset(df, altitude_low_meters < 8848) #clean altitude upperbound
df <- subset(df, altitude_low_meters/Elevation > 0.2) #clean altitude lowerbound
```

```{r dataset glimpse}
df <- df[,c("country", "Species", "Producer", "Harvest.Year", "Expiration", "Category.One.Defects", "Category.Two.Defects", "Total.Cup.Points", "altitude_low_meters", "Variety", "Species", "subregion", "Tropical")]

glimpse(df)
```
```{r histograms_2, out.width="70%", align = 'center', fig.cap="Homoskedastic Errors on Residuals vs Fitted", echo=FALSE, include=TRUE}

hist(df$Total.Cup.Points, which=3,ylab=NULL,main=NULL)
hist(df$altitude_low_meters, which=3,ylab=NULL,main=NULL)

```

```{r correlation in between X and Y?}
ggplot(df, aes(x = altitude_low_meters, 
                 y = Total.Cup.Points)) + 
  geom_point( alpha = 0.8, size = 1) +
  geom_smooth(method = "lm", se = F) +
  ylab("Coffee rating") +
  xlab("Coffee growing altitude (meters)") +
  labs(title = 'Relationship between altitude and coffee ratings',
    subtitle = '{closest_state}')
```

```{r correlation in between X and Y?}
ggplot(df, aes(x = log(altitude_low_meters), 
                 y = Total.Cup.Points)) + 
  geom_point( alpha = 0.8, size = 1) +
  geom_smooth(method = "lm", se = F) +
  ylab("Coffee rating") +
  xlab("Coffee growing altitude (meters)") +
  labs(title = 'Relationship between altitude and coffee ratings',
    subtitle = '{closest_state}')
```
Taking a look at the number of observations by country, only the 10 have more than 30 samples per country. Which could lead to issues on Large Sample assumptions, and also overfitting of the model. 

```{r modificacao2}
df2 <- df %>% count(country, sort = TRUE)
head(df2,33)

df3 <- df2 %>% filter(n<30)
head(df3,33)

df_ <- df %>% 
  filter(!is.na(country),
         Total.Cup.Points > 10) %>% 
  mutate(country = fct_lump(country, 10), sort = TRUE)

df_ %>% 
  mutate(country = fct_reorder(country, Total.Cup.Points)) %>% 
  ggplot(aes(Total.Cup.Points, country)) +
  geom_boxplot()

```

In order to address that, we decided to group by geographical subRegion. That way, the most troublesome category presented is Oceania. Which we decided to leave out for the sake of this analysis.

```{r modificacao3}
df2 <- df %>% count(subregion, sort = TRUE)
head(df2,33)

df_ <- df %>% 
  filter(!is.na(subregion),
         Total.Cup.Points > 10) %>% 
  mutate(region = fct_lump(subregion, 10), sort = TRUE)

df_ %>% 
  mutate(region = fct_reorder(subregion, Total.Cup.Points)) %>% 
  ggplot(aes(Total.Cup.Points, subregion)) +
  geom_boxplot()

```

```{r exclude subregions}
df <- subset(df, subregion != "Caribbean") #clean invalid score
df <- subset(df, subregion != "Western Africa, Sub-Saharan Africa") #clean invalid score
df <- subset(df, subregion != "Melanesia") #clean invalid score
df <- subset(df, subregion != "Northern America") #clean invalid score
df <- subset(df, subregion != "Southern Asia, South Central Asia") #clean invalid score

df %>% count(subregion, sort = TRUE)
```

```{r divide into train and test}
library(splitstackshape)

set.seed(19108379) 
df$rowId <- 1:nrow(df)
train <- stratified(df,"subregion",size =0.3)
test <- df[!(df$rowId %in% train$rowId),]

```

```{r load robust standard error puller} 
rse <- function(model) { 
  sqrt(diag(vcovHC(model)))
}
```


```{r estimate models}
v1<-lm(Total.Cup.Points ~ altitude_low_meters, data = train)
v2<-lm(Total.Cup.Points ~ log(altitude_low_meters), data = train)

v3<-lm(Total.Cup.Points ~ altitude_low_meters + subregion, data=train) #adding Variables
v4<-lm(Total.Cup.Points ~ altitude_low_meters + Tropical, data=train) #adding Variables

v5<-lm(Total.Cup.Points ~ altitude_low_meters + subregion + Tropical, data=train) #adding Variables

v6<-lm(Total.Cup.Points ~ altitude_low_meters + subregion + Tropical + subregion*Tropical, data=train) #adding interaction term

v7<-lm(Total.Cup.Points ~ altitude_low_meters + subregion + Tropical + subregion * Tropical - `subregion Eastern Asia:TropicalNotTropical`, data = train)
```


```{r c, out.width="50%", align = 'center', fig.cap="Residuals, Normality and Linearity on Transformation or Not", echo=FALSE, include=TRUE}

test <- test %>%
  mutate(yhats = predict(v1,newdata = test))

test <- test %>%
  mutate(resids = Total.Cup.Points-yhats)

test <- test %>%
  mutate(yhats2 = predict(v2,newdata = test))

test <- test %>%
  mutate(resids2 = Total.Cup.Points-yhats2)


hist_v1_resids <- test %>%
  ggplot(aes(x = resids)) +
  geom_histogram()

scatter_v1_resids <- test %>%
  ggplot(aes(yhats, resids)) +
  geom_point() + 
  stat_smooth()

hist_v2_resids <- test %>%
  ggplot(aes(x = resids2)) +
  geom_histogram()

scatter_v2_resids <- test %>%
  ggplot(aes(yhats2, resids2)) +
  geom_point() + 
  stat_smooth()

grid.arrange(hist_v1_resids, hist_v2_resids, scatter_v1_resids, scatter_v2_resids)


```



```{r Shapiro–Wilk Test for model 1 and 2, include=TRUE}
shapiro.test(test$resids)
```

```{r Shapiro–Wilk Test for model 1 and 2, include=TRUE}
shapiro.test(test$resids6)
```
```{r model 6, include=TRUE}
plot(v6)
summary(v6)
```

```{r model 6, include=TRUE}
vif(v6)
alias(v6)
plot(lm(formula = Total.Cup.Points ~ altitude_low_meters + subregion + 
    Tropical + subregion * Tropical, data = test))
vif(v5)

```

```{r ...}

test <- test %>%
  mutate(yhats3 = predict(v3,newdata = test))

test <- test %>%
  mutate(resids3 = Total.Cup.Points-yhats3)

test <- test %>%
  mutate(yhats4 = predict(v4,newdata = test))

test <- test %>%
  mutate(resids4 = Total.Cup.Points-yhats4)

test <- test %>%
  mutate(yhats5 = predict(v5,newdata = test))

test <- test %>%
  mutate(resids5 = Total.Cup.Points-yhats5)

test <- test %>%
  mutate(yhats6 = predict(v6,newdata = test))

test <- test %>%
  mutate(resids6 = Total.Cup.Points-yhats6)

hist_v3_resids <- test %>%
  ggplot(aes(x = resids3)) +
  geom_histogram()

scatter_v3_resids <- test %>%
  ggplot(aes(yhats, resids3)) +
  geom_point() + 
  stat_smooth()

hist_v4_resids <- test %>%
  ggplot(aes(x = resids4)) +
  geom_histogram()

scatter_v4_resids <- test %>%
  ggplot(aes(yhats, resids4)) +
  geom_point() + 
  stat_smooth()

hist_v5_resids <- test %>%
  ggplot(aes(x = resids5)) +
  geom_histogram()

scatter_v5_resids <- test %>%
  ggplot(aes(yhats, resids5)) +
  geom_point() + 
  stat_smooth()


hist_v6_resids <- test %>%
  ggplot(aes(x = resids6)) +
  geom_histogram()

scatter_v6_resids <- test %>%
  ggplot(aes(yhats, resids6)) +
  geom_point() + 
  stat_smooth()


grid.arrange(hist_v3_resids, scatter_v3_resids)
grid.arrange(hist_v4_resids, scatter_v4_resids)
grid.arrange(hist_v5_resids, scatter_v5_resids)
grid.arrange(hist_v6_resids, scatter_v6_resids)

```


```{r ...}
test_predictions <- predict(v6, newdata = test)
threshold <- 85 # adjust the threshold as needed
binary_predictions <- ifelse(test_predictions > threshold, 1, 0)

binary_actual <- ifelse(test$Total.Cup.Points > threshold, 1, 0)
binary_predictions_factor <- factor(binary_predictions, levels = c(0, 1))
binary_actual_factor <- factor(binary_actual, levels = c(0, 1))
confusion_matrix <- confusionMatrix(binary_predictions_factor, binary_actual_factor)
print(confusion_matrix)

```