---
title: "Unit 12 HW: The Classical Linear Model"
output: 'pdf_document'
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(patchwork)
library(lmtest)
library(sandwich)
library(stargazer)
```

```{r chunk options, include=FALSE}
knitr::opts_chunk$set(message=FALSE, dpi=300)
```

```{r get robust ses, include=FALSE}
rse <- function(model) { 
  sqrt(diag(vcovHC(model)))
  }
```

```{r load-data, message=FALSE, include=FALSE}

videos <- read_delim("videos.txt", delim = "\t")
videosfo <- videos %>% filter(!is.na(videos$views))

glimpse(videosfo)
summary(videosfo)
```

```{r, include=FALSE}
videos_model <-lm(log(views) ~ rate + length, data=videosfo)
videos_model2 <-lm(views ~ rate + length, data=videosfo)

```

```{r plot straight up, include=FALSE}
plot(videos_model)
```

**1.3 - Linear conditional expectation**

```{r ggplot, out.width="50%", fig.cap="Linear Conditional Expectation on Precdicted vs Residuals", echo=FALSE, include=TRUE}

videosfo %>% 
  mutate(
    model_one_preds = predict(videos_model), 
    model_one_resids = resid(videos_model)
  ) %>% 
  ggplot(aes(model_one_preds, model_one_resids)) + 
  geom_point() + 
  stat_smooth()

```

By the above *Residual vs. Estimators* graph, it's possible to note that a non-linear relationship in this data. That said, linear conditional expectation assumption is not met. Specially toward the right end of the data (around 7.5 and on), our model seem to shift pattern and start to produce different patterned residuals. 
In order to go around this, one could try to breakdown the model in two sets, or maybe a different variable transformation, hoping to end up with a more linear pattern.

\newpage
**1.4 Homoskedastic Error**

```{r, out.width="50%", fig.cap="Homoskedastic Errors on Residuals vs Fitted", echo=FALSE, include=TRUE}
plot(videos_model, which=3)
```
To assess whether the distribution of the errors is homoskedastic, we can examine the residuals versus fitted plot again and also run a Breusch-Pagan Test. With a very strong p-value significance (p-value < 2.2e-16), the null hypothesis is rejected, leading us to believe that Heteroskedastic errors are present. By the plot above, it does look there is some in balance in the variance of the residuals specially after the before mention tipping point. Meaning that not only the linearity is compromised, but also pointing out to the presence of different variance patterns.
All that said, the assumption was not met. In order to correct this, there's the possibility to use a robust covariance matrix which in mild conditions could help with this issue.

```{r}
bptest(videos_model)
```

